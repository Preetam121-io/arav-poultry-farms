<script>
    let p_price = 0, p_name = "", p_unit = "";

    function openOrder(name, price, unit) {
        p_name = name; p_price = price; p_unit = unit;
        document.getElementById('sel-item').innerText = name;
        document.getElementById('sel-rate').innerText = price;
        document.getElementById('sel-unit').innerText = unit;
        recalc();
        document.getElementById('main').style.display = 'none';
        document.getElementById('checkout').style.display = 'block';
        window.scrollTo(0,0);
    }

    function closeOrder() {
        document.getElementById('main').style.display = 'block';
        document.getElementById('checkout').style.display = 'none';
    }

    function recalc() {
        const q = document.getElementById('order-qty').value || 1;
        const total = q * p_price;
        document.getElementById('order-total').innerText = total;
        document.getElementById('upi-btn-val').innerText = total;
    }

    function validate() {
        const n = document.getElementById('user-name').value;
        const a = document.getElementById('user-addr').value;
        if(!n || !a) { alert("Please enter Name and Address."); return false; }
        return { name: n, addr: a };
    }

    function handleUPI() {
        const user = validate(); if(!user) return;
        const total = document.getElementById('order-total').innerText;
        const upiId = "7338242455@ybl";
        
        // Dynamic QR for all devices (Most reliable way to avoid declines)
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=upi://pay?pa=${upiId}%26pn=Arav%20Poultry%26am=${total}%26cu=INR%26tn=OrderBy${encodeURIComponent(user.name)}`;

        const overlay = document.createElement('div');
        overlay.id = "payment-overlay";
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
        overlay.innerHTML = `
            <div style="background:white; padding:25px; border-radius:20px; text-align:center; width:100%; max-width:350px;">
                <h3 style="margin:0 0 10px 0; color:#1b4332;">Pay ₹${total}</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">If the app doesn't open, scan the QR or copy ID</p>
                
                <img src="${qrUrl}" style="width:200px; margin-bottom:15px; border:1px solid #eee; padding:5px;">
                
                <button onclick="window.location.href='upi://pay?pa=${upiId}&pn=Arav%20Poultry&am=${total}&cu=INR'" 
                        style="background:#0055a4; color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:10px;">
                        Open Payment App
                </button>

                <div style="background:#f4f4f4; padding:10px; border-radius:8px; font-size:14px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span>${upiId}</span>
                    <button onclick="navigator.clipboard.writeText('${upiId}'); alert('Copied!')" style="border:none; background:none; color:#0055a4; font-weight:bold; cursor:pointer;">Copy</button>
                </div>

                <button onclick="document.getElementById('payment-overlay').remove()" style="background:#eee; color:#333; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer;">Close</button>
            </div>`;
        document.body.appendChild(overlay);
    }

    function handleWA() {
        const user = validate(); if(!user) return;
        const q = document.getElementById('order-qty').value;
        const t = document.getElementById('order-total').innerText;
        const msg = `*NEW ORDER*%0A*Item:* ${p_name}%0A*Qty:* ${q}%0A*Total:* ₹${t}%0A*Name:* ${user.name}%0A*Address:* ${user.addr}`;
        window.open(`https://wa.me/917338242455?text=${msg}`, '_blank');
    }
</script>
